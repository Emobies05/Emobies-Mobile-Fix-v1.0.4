name: Emobies Production APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          cache: true

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Android project structure
        run: flutter create --org com.nxtbit --project-name emobies_app .

      - name: Get dependencies
        run: flutter clean && flutter pub get

      - name: Decode keystore
        run: |
          mkdir -p android/app
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/emobies.keystore
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=emobies.keystore
          EOF

      - name: Build signed APK
        run: flutter build apk --release --dart-define=API_BASE="${{ secrets.API_BASE_URL }}"

      - name: Build signed AAB
        run: flutter build appbundle --release --dart-define=API_BASE="${{ secrets.API_BASE_URL }}"

      - name: Prepare artifacts
        run: |
          mkdir -p dist
          cp build/app/outputs/flutter-apk/app-release.apk dist/Emobies-${{ steps.version.outputs.version }}.apk
          cp build/app/outputs/bundle/release/app-release.aab dist/Emobies-${{ steps.version.outputs.version }}.aab
          ls -la dist/

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Emobies-APK
          path: dist/*.apk
          retention-days: 30

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: Emobies-AAB-PlayStore
          path: dist/*.aab
          retention-days: 30

    - name: Decode keystore
      run: |
        mkdir -p android/app
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/emobies.keystore
        cat > android/key.properties <<EOF
        storePassword=${{ secrets.KEYSTORE_PASSWORD }}
        keyPassword=${{ secrets.KEY_PASSWORD }}
        keyAlias=${{ secrets.KEY_ALIAS }}
        storeFile=emobies.keystore
        EOF

    - name: Build signed APK
      run: |
        flutter build apk --release \
          --dart-define=API_BASE=${{ secrets.API_BASE_URL }}

    - name: Build signed AAB
      run: |
        flutter build appbundle --release \
          --dart-define=API_BASE=${{ secrets.API_BASE_URL }}

    - name: Prepare artifacts
      run: |
        mkdir dist
        cp build/app/outputs/flutter-apk/app-release.apk dist/Emobies-${{ steps.version.outputs.version }}.apk
        cp build/app/outputs/bundle/release/app-release.aab dist/Emobies-${{ steps.version.outputs.version }}.aab
        ls -la dist/

    - uses: actions/upload-artifact@v4
      with:
        name: Emobies-APK
        path: dist/*.apk
        retention-days: 30

    - uses: actions/upload-artifact@v4
      with:
        name: Emobies-AAB-PlayStore
        path: dist/*.aab
        retention-days: 30
